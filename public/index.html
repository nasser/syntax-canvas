<!doctype html>
<html>
<head>
  <title>Syntax Canvas</title>
    <link rel="stylesheet" href="codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="codemirror/theme/ambiance.css">
    <link rel="stylesheet" href="bootstrap/css/bootstrap.css">
    <style type="text/css">
      .nav {
        margin-top: 1em;
        margin-bottom: 5px;
        padding: 0 1em;
      }


      form {
        margin: 0;
      }

      .parser {
        margin-top: 1px;
      }

      .nav {
        min-height: 37px;
      }

      .nav button {
        margin-left: 5px;
      }

      .nav input:focus {
        outline: none;
      }
      .nav input {
        border: none;
        padding: 0;
        height: 18px;
        position: relative;
        top: -2px;
      }

      .nav li.active i {
        background-image: url("bootstrap/img/glyphicons-halflings.png") !important;
        margin-left: 0.5em;
      }

      #introduction h1 {
        text-align: center;
        font-size: 7em;
        padding: 0.5em;

        /* http://simurai.com/post/698681341/inset-text-shadow */
        color: transparent;
        background-color: rgba(82,96,117,0.5);
        -webkit-background-clip: text;
        text-shadow: rgba(255,255,255,0.5) 0 5px 6px;
      }

      #introduction h2 {
        text-align: center;
      }

      #introduction p {
        text-align: center;
      }

      #help-window {
        display: none;
      }

    </style>
    <script src="codemirror/lib/codemirror.js"></script>
    <script src="codemirror/mode/flexible/flexible.js"></script>
    <script src="codemirror/mode/slymtax/slymtax.js"></script>
    <script src="codemirror/mode/javascript/javascript.js"></script>
    <script src="codemirror/mode/css/css.js"></script>

    <script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
    <script src="bootstrap/js/bootstrap.js"></script>

    <script src="http://github.com/downloads/dmajda/pegjs/peg-0.7.0.min.js"></script>
    <script src="namegenerator.js"></script>
    
    <script type="text/javascript">
    String.prototype.hashCode = function(){
      var hash = 0, i, char;
      if (this.length == 0) return hash;
      for (i = 0; i < this.length; i++) {
          char = this.charCodeAt(i);
          hash = ((hash<<5)-hash)+char;
          hash = hash & hash; // Convert to 32bit integer
      }
      return hash;
    };

    var codeMirrors = [];
    var didIntroduction = false;

    function showIntroduction () {
      didIntroduction = true;
      $(".tab-content").append("<div id='introduction'><h1>Syntax Canvas</h1><h2>A tool for experiments in language design</h2></div>");
      $("#add-language").tooltip({trigger:'manual', title:'Click here to start your next language', placement:'left'});
      setTimeout(function() {$("#add-language").tooltip('show');}, 5000);
    }

    function refreshEditors() {
      var tabHeight = $(window).outerHeight() - $(".nav").outerHeight(true);
      $(".code .CodeMirror-scroll").height(tabHeight * 0.75);
      $(".parser .CodeMirror-scroll").height(tabHeight * 0.25 - 1);

      for (var i = codeMirrors.length - 1; i >= 0; i--) { codeMirrors[i].refresh(); };
    }

    function addLanguage (name, code, syntax) {
      $(".nav a").tooltip('destroy')

      var hash = name.hashCode();

      // create tab
      var tab = $("<li><a href=\"#tab-" + hash + "\" data-toggle=\"tab\">" + name + "</a></li>");

      // show tab on click
      $(tab).find("a").click(function (e) {
        e.preventDefault();
        $(this).tab('show');

        refreshEditors();
      });

      // edit language name on double click
      $(tab).find("a").dblclick(function (e) {
        e.preventDefault();
        var $this = $(this);

        $(".nav a").tooltip('destroy')

        // create input element
        var controls =  $("<input style='width:" + $this.width() + "px' placeholder='" + name + "'></input><i class=\"icon-remove icon-black\"></i>");
        var input = controls.eq(0);
        var remove = controls.eq(1);

        // escape or enter with no text resets name, enter with text sets new name
        input.keydown(function(k) {
          var code = k.keyCode || k.which;
          if(code == 27) { // escape
            k.preventDefault();
            $this.html(name);

          } else if(code == 13) { // enter
            k.preventDefault();
            if(input.val() == "") {
              $this.html(name);

            } else {
              var newName = input.val();
              $this.html(newName);
              localStorage.setItem(newName, localStorage.getItem(name));
              localStorage.removeItem(name);
            }
          }
        });

        // losing focus resets name
        input.blur(function () {
          // must timeout, otherwise clicking the remove button is impossible
          setTimeout(function() { $this.html(name); }, 100);
        });

        // remove button 
        remove.click(function (e) {
          tab.remove();
          $("#tab-" + hash).remove();
          localStorage.removeItem(name);

          if($(".nav a").size() == 0) {
              showIntroduction();
          } else {
            $(".nav a:first").click();
          }
        });

        $this.html(controls);
        input.focus();
      });

      // create tab content pane
      var tabPane = $("<div class=\"tab-pane\" id=\"tab-" + hash + "\"> <form class=\"code\"><textarea></textarea></form> <form class=\"parser\"><textarea></textarea></form> </div>");

      // add syntax editor
      var parser = CodeMirror.fromTextArea($(tabPane).find('.parser textarea').get(0), {
        theme:"ambiance",
        mode: "text/slymtax",
        smartIndent:false,
        onChange:function() {
          var Syntax = [];
          var syntaxLines = parser.getValue().split("\n");
          for (var i = syntaxLines.length - 1; i >= 0; i--) {
            try {
              var matches, token, styles;
              if(matches = /\/([^\/]+)\/\s*:\s*(.+)/.exec(syntaxLines[i])) {
                // regexp rule
                token = new RegExp("^" + matches[1].trim().replace(/ /g, "")); // whitespace replace, bad idea?
                styles = matches[2].trim().split(" ");
                
              } else if(matches = /'([^']+)'\s*:\s*(.+)/.exec(syntaxLines[i])) {
                // string rule
                token = matches[1].trim();
                styles = matches[2].trim().split(" ");

              } else {
                continue;
              }
              
              if(typeof styles != "undefined" && typeof token != "undefined") Syntax.push([token, styles]);

            } catch(e) {}
          }

          parser.syntax = Syntax;
          editor.setOption("mode", editor.getOption("mode")) // refresh editor
        }
      });
      parser.syntax = [];

      // add code editor
      var editor = CodeMirror.fromTextArea($(tabPane).find('.code textarea').get(0), {
        theme:"ambiance",
        mode: {
          name: "flexible",
          parser: parser
        },
        lineNumbers: true,

        onHighlightComplete:function() {
          localStorage.setItem(name, JSON.stringify({ code:editor.getValue(), syntax:parser.getValue() }));
        }
      });

      // populate editors
      editor.setValue(code);
      parser.setValue(syntax);

      // refresh editor
      editor.setOption("mode", editor.getOption("mode")); 

      // store editors for future
      codeMirrors.push(parser);
      codeMirrors.push(editor);

      // insert tab and content into dom
      $(".nav").append(tab);
      $(".tab-content").append(tabPane);

      if($(".nav a").size() == 1 && didIntroduction) {
        setTimeout(function() {
          $(".nav a:first").tooltip({trigger:'manual', title:'Double click to change the language\'s name or delete it.' , placement:'right'});
          $(".nav a:first").tooltip('show')
          setTimeout(function() { $(".nav a").tooltip('destroy')}, 8000);
        }, 5000);
      }
    }



    $(function() {
      $(window).resize(function() {
        refreshEditors();
      });

      $("#add-language").click(function () {
        $("#introduction").remove();
        $("#add-language").tooltip('destroy');

        addLanguage(
          NameGenerator.makeName("adjective%5 [animal name gem planet tree emotion letter] suffix%2"),
          "# Type your code here, and your syntax in the lower pane\n# \n# The syntax pane's syntax is MATCH : STYLE+\n# \n# MATCH is a single quoted string ('foo'), a simple\n# regex (/--.*/), or a regex with captures (/(\w+)=(\d+)/)\n# \n# STYLE is an unquoted style name, indicating\n# how to style the text. Available styles are: keyword, atom,\n# number, def, variable, variable-2 variable-3, property,\n# operator, comment, string, string-2 meta, error, qualifier,\n# builtin, bracket, tag, attribute header, quote, hr, link\n\nself.range = (10...32)\n",
          "/\\((\\d+)(...)(\\d+)\\)/ : number operator number\n/#.*/ : comment\n'self' : builtin")
        $(".nav a:last").click();
      });

      $("#help").click(function() {
        $("#help-window").modal();
      });

      for (var i = localStorage.length - 1; i >= 0; i--) {
        var name = localStorage.key(i);
        var data = JSON.parse(localStorage.getItem(name));
        if(data)
          addLanguage(name, data.code, data.syntax)
      }

      if($(".nav a").size() == 0) {
        showIntroduction();
      }

      $(".nav a:first").click();
      refreshEditors();
    });
</script>
</head>
<body>
  <ul class="nav nav-tabs">
    <li class="pull-right"><button id="help" class="btn btn-small btn-inverse"><i class="icon-question-sign icon-white"></i></button></li>
    <li class="pull-right"><button id="add-language" class="btn btn-small btn-primary"><i class="icon-plus icon-white"></i></button></li>
  </ul>
  <div class="tab-content"></div>

  <div class="modal" id="help-window" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
    <h3 id="myModalLabel">Syntax Canvas</h3>
  </div>
  <div class="modal-body">
    <p>Made at <a href="http://eyebeam.org/" target="_blank">Eyebeam</a> by <a href="http://nas.sr/" target="_blank">Ramsey Nasser</a> who, incidentally, send you his love.</p>
    <p>Powered by <a href="http://codemirror.net/" target="_blank">CodeMirror</a>, <a href="http://twitter.github.com/bootstrap/" target="_blank">Bootstrap</a>, <a href="http://glyphicons.com/" target="_blank">Glyphicons</a>, <a href="http://pegjs.majda.cz/" target="_blank">PEG.js</a> and <a href="http://jquery.com/" target="_blank">jQuery</a>.</p>
    <p>Check out <a target="_blank" href="https://github.com/nasser/syntax-canvas">the code</a> because it's <a target="_blank" href="http://opensource.org/licenses/MIT">MIT licensed</a> and you know you're dying to know how the live syntax rehighlighter works.
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
  </div>
</div>
<script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '508ae464f5a1f530f200003f');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>
</body>
</html>